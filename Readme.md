# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Решение 1

В сравнительной таблице оцениваются следующие API-шлюзы:
1. Kong
2. KrakenD
3. Tyk
4. Nginx
5. APISIX
6. Gloo Edge


| Правило сравнения      |          Kong               |               KrakenD       |          Tyk            |        Nginx         |       APISIX            |     Gloo Edge           |
|------------------------|-----------------------------|-----------------------------|-------------------------|----------------------|-------------------------|-------------------------|
| Язык разработки        |          Lua                |              Go             |           Go            |         C            |         Lua             |        Go               |
| Библиотека плагинов    | Более 90. Можно писать свои.|  Нет. Можно писать свои.    | Есть. Можно писать свои.|         Нет          | Есть. Можно писать свои.| Есть. Можно писать свои.| 
| Возможность доработки  | Высокая                     |           Низкая            |        Высокая          |        Высокая       |         Высокая         |       Самая низкая      |      
| Производительность     | 100 уе                      |           190 уе            |           30уе          |         210уе        |         140уе           |          190уе          |
| Композиция данных      | Нет                         |          Есть               |           Есть          |          Нет         |           Нет           |           Нет           |
| Хранилище              | PostgreSQL                  |        Собственное          |           Redis         |        Файловое      |         etcd            |        Собственное      |
| GraphQL                | Есть                        |           Есть              |           Есть          |          Нет         |         Есть            |            Есть         |

### Вывод: 
1. Для простых задач вполне подойдет Nginx, т.к. он умеет осуществлять балансировку, терминацию https, проверку аутентификации 
2. Для более сложных задач(требующих работы с разными технологическими стеками(Net Core, Node.JS и другие), использования различных стратегий развертывания и поддержки различных протоколов взаимодействия, таких как gRPC) подойдет APISIX. Этот шлюз имеет высокую производительность, большой функционал, хорошо масштабируется и имеет достаточно большое сообщество пользователей. Однако в нем отсутствует возможность встроенной композиции данных.   
3. Если требуется высоконагруженное решение со встроенным механизмом композиции данных, то подойдет KrakenD. Однако, его возможно дорабатывать только на языке Go и у него нет собственной библиотеки готовых плагинов, как у Kong и APISIX.

### Использованные материалы:

1. [публикации сотрудников Амедиатека на habr-е](https://habr.com/ru/articles/765944/)
2. [сравнительная оценка производительности kong и apisix](https://api7.ai/blog/apisix-kong-3-0-performance-comparison)
3. [оценке латентности Envoy Proxy на котором построен Gloo Edge](https://github.com/envoyproxy/envoy/issues/28318)


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Решение 2

В сравнительном анализе рассматриваются следующие брокеры сообщений:
1. Kafka
2. RabbitMQ
3. Pulsar

| Правило сравнения      |          Kafka               |               RabbitMQ       |          Pulsar            |
|------------------------|------------------------------|------------------------------|----------------------------|
| Максимальная нагрузка  |           605 Мбит           |                 38 Мбит      |            305Мбит         |
| Латентность(мсек)      |           5 (200 Мбит)       |                1 (30 Мбит)   |             25(200 Мбит)   |
| Сегментирование        |           Есть               |                 Нет          |             Есть           |
| Повторное чтение       |           Есть               |                 Нет          |             Есть           |
| Балансировка нагрузки  |           Есть               |                 Есть         |             Есть           |         

### Выводы

Наилучшим решением по производительности и цене развертывания является kafka. Это также подтверждается тем, что Twitter отказался от решения на базе Pulsar в пользу Kafka.


### Используемая литература:
1. [Benchmarking Kafka,RabbitMQ, Pulsar](https://www.confluent.io/blog/kafka-fastest-messaging-system/)

